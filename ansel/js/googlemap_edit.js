Ansel_MapEdit=Class.create();Ansel_MapEdit.prototype={_options:null,_map:null,ll:null,initialize:function(a){this._options=Object.extend({statusId:"status",locationInput:"locationInput",locationAction:"locationAction",isNew:"0"},a);this._map=new Ansel_GMap({mainMap:this._options.mainMap,viewType:"Edit",useManager:false,clickHandler:function(c,d,b){this._map.points[0].setLatLng(d);this._map.points[0].image_data={image_location:"",image_latitude:d.lat(),image_longitude:d.lng()};this._map.getLocations(this._map.points[0])}.bind(this)});if(this._options.isNew){this._map.maxZoom=1}this._map._getLocationCallback=this._map.getLocationCallback;this._map.getLocationCallback=function(c,b){this._map._getLocationCallback(c,b)}.bind(this);this._map.addPoints(this._options.points);this._map.display();$(this._options.locationAction).observe("click",function(b){this.getLocation();b.stop()}.bindAsEventListener(this));$(this._options.saveId).observe("click",function(){this.handleSave(this._options.image_id)}.bind(this))},handleSave:function(b){var a=this._options;params={requestType:"ImageSaveGeolocation/type=geotag/img="+b+"/lat="+this._map.points[0].getLatLng().lat()+"/lng="+this._map.points[0].getLatLng().lng()};url=this._options.url;new Ajax.Request(a.xurl,{method:"post",parameters:params,onComplete:function(c){if(c.responseText==1){window.opener.location.href=window.opener.location.href;window.close()}}})},getLocation:function(){var b=this._options;$(this._options.statusId).update(this._options.gettext.fetching);if(this.ll){var a=new GLatLng(this.ll.image_latitude,this.ll.image_longitude);this._map.points[0].setLatLng(a);this._map.points[0].image_data={image_location:$F(b.locationInput),image_latitude:a.lat(),image_longitude:a.lng()};this._map.getLocations(this._map.points[0]);this._map.mainMap.setCenter(a,this._map.defaultZoom);$(b.statusId).update("")}else{this._map.geocoder.getLocations($(b.locationInput).value,function(c){if(c.Status.code=="200"){var f=c.Placemark[0].Point.coordinates[1];var e=c.Placemark[0].Point.coordinates[0];var d=new GLatLng(f,e);this._map.points[0].setLatLng(d);this._map.points[0].image_data={image_location:"",image_latitude:f,image_longitude:e};this._map.getLocations(this._map.points[0]);this._map.mainMap.setCenter(d,this._map.defaultZoom);$(b.statusId).update("")}else{$(b.statusId).update(b.gettext.errortext+c.Status.code)}}.bind(this))}},setLocation:function(c,b,d){var a=new GLatLng(c,b);this._map.points[0].setLatLng(a);this._map.points[0].image_data={image_location:d,image_latitude:c,image_longitude:b};this._map.getLocations(this._map.points[0]);this._map.mainMap.setCenter(a,this._map.defaultZoom)}};Ajax.Autocompleter.prototype.updateChoices=function(g){var a,e,d,c=0;this.geocache=g;var f=$H(g);if(!this.changed&&this.hasFocus){a=new Element("LI");d=new Element("UL");e=new RegExp("("+this.getToken()+")","i");var b=f.keys();b.each(function(h){d.insert(a.cloneNode(false).writeAttribute("acIndex",c++).update(h.gsub(e,"<strong>#{1}</strong>")))});this.update.update(d);this.entryCount=b.size();d.childElements().each(this.addObservers.bind(this));this.stopIndicator();this.index=0;if(this.entryCount==1&&this.options.autoSelect){this.selectEntry()}else{this.render()}}if(this.options.afterUpdateChoices){this.options.afterUpdateChoices(f,d)}};Autocompleter.Local.prototype.initialize=function(b,d,c,a){this.baseInitialize(b,d,a);this.geocache=c;this.options.arr=$H(c).keys()};