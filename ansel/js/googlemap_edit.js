Ansel_MapEdit=Class.create();Ansel_MapEdit.prototype={_options:null,_map:null,ll:null,initialize:function(A){this._options=Object.extend({statusId:"status",locationInput:"locationInput",locationAction:"locationAction",isNew:"0"},A);this._map=new Ansel_GMap({mainMap:this._options.mainMap,viewType:"Edit",useManager:false,clickHandler:function(C,D,B){this._map.points[0].setLatLng(D);this._map.points[0].image_data={image_location:"",image_latitude:D.lat(),image_longitude:D.lng()};this._map.getLocations(this._map.points[0])}.bind(this)});if(this._options.isNew){this._map.maxZoom=1}this._map._getLocationCallback=this._map.getLocationCallback;this._map.getLocationCallback=function(C,B){this._map._getLocationCallback(C,B)}.bind(this);this._map.addPoints(this._options.points);this._map.display();$(this._options.locationAction).observe("click",function(B){this.getLocation();B.stop()}.bindAsEventListener(this));$(this._options.saveId).observe("click",function(){this.handleSave(this._options.image_id)}.bind(this))},handleSave:function(B){var A=this._options;params={requestType:"ImageSaveGeolocation/type=geotag/img="+B+"/lat="+this._map.points[0].getLatLng().lat()+"/lng="+this._map.points[0].getLatLng().lng()};url=this._options.url;new Ajax.Request(A.xurl,{method:"post",parameters:params,onComplete:function(C){if(C.responseText==1){window.opener.location.href=window.opener.location.href;window.close()}}})},getLocation:function(){var B=this._options;$(this._options.statusId).update(this._options.gettext.fetching);if(this.ll){var A=new GLatLng(this.ll.image_latitude,this.ll.image_longitude);this._map.points[0].setLatLng(A);this._map.points[0].image_data={image_location:$F(B.locationInput),image_latitude:A.lat(),image_longitude:A.lng()};this._map.getLocations(this._map.points[0]);this._map.mainMap.setCenter(A,this._map.defaultZoom);$(B.statusId).update("")}else{this._map.geocoder.getLocations($(B.locationInput).value,function(C){if(C.Status.code=="200"){var F=C.Placemark[0].Point.coordinates[1];var E=C.Placemark[0].Point.coordinates[0];var D=new GLatLng(F,E);this._map.points[0].setLatLng(D);this._map.points[0].image_data={image_location:"",image_latitude:F,image_longitude:E};this._map.getLocations(this._map.points[0]);this._map.mainMap.setCenter(D,this._map.defaultZoom);$(B.statusId).update("")}else{$(B.statusId).update(B.gettext.errortext+C.Status.code)}}.bind(this))}},setLocation:function(C,B,D){var A=new GLatLng(C,B);this._map.points[0].setLatLng(A);this._map.points[0].image_data={image_location:D,image_latitude:C,image_longitude:B};this._map.getLocations(this._map.points[0]);this._map.mainMap.setCenter(A,this._map.defaultZoom)}};Ajax.Autocompleter.prototype.updateChoices=function(G){var A,E,D,C=0;this.geocache=G;var F=$H(G);if(!this.changed&&this.hasFocus){A=new Element("LI");D=new Element("UL");E=new RegExp("("+this.getToken()+")","i");var B=F.keys();B.each(function(H){D.insert(A.cloneNode(false).writeAttribute("acIndex",C++).update(H.gsub(E,"<strong>#{1}</strong>")))});this.update.update(D);this.entryCount=B.size();D.childElements().each(this.addObservers.bind(this));this.stopIndicator();this.index=0;if(this.entryCount==1&&this.options.autoSelect){this.selectEntry()}else{this.render()}}if(this.options.afterUpdateChoices){this.options.afterUpdateChoices(F,D)}};Autocompleter.Local.prototype.initialize=function(B,D,C,A){this.baseInitialize(B,D,A);this.geocache=C;this.options.arr=$H(C).keys()};