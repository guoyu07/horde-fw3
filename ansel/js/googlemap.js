var Ansel_GMap=Class.create();Ansel_GMap.prototype={mainMap:undefined,smallMap:undefined,tI:undefined,tIO:undefined,bounds:undefined,geocoder:undefined,manager:undefined,tilePrefix:"imagetile_",locationId:"ansel_locationtext",coordId:"ansel_latlng",relocateId:"ansel_relocate",deleteId:"ansel_deleteGeotag",maxZoom:15,defaultZoom:15,options:{},points:[],initialize:function(b){if(typeof b.useManager=="undefined"){b.useManager=true}this.mainMap=new GMap2($(b.mainMap));this.mainMap.setMapType(G_HYBRID_MAP);this.mainMap.setUIToDefault();this.bounds=new GLatLngBounds();this.geocoder=new GClientGeocoder();this.options=b;if(b.tilePrefix){this.tilePrefix=b.tilePrefix}if(typeof b.calculateMaxZoom=="undefined"){b.calculateMaxZoom=true}if(b.smallMap){this.smallMap=new GMap2($(b.smallMap));var c=this.smallMap.getDefaultUI();c.controls.menumaptypecontrol=false;this.smallMap.setUI(c);this.tI=new GIcon();this.tI.image="http://labs.google.com/ridefinder/images/mm_20_red.png";this.tI.shadow="http://labs.google.com/ridefinder/images/mm_20_shadow.png";this.tI.iconSize=new GSize(12,20);this.tI.shadowSize=new GSize(22,20);this.tI.iconAnchor=new GPoint(6,20);this.tI.infoWindowAnchor=new GPoint(5,1);this.tIO={icon:this.tI}}document.observe("unload",function(){GUnload()})},addPoints:function(e,j){var c=e.length;for(var d=0;d<c;d++){var h=new GLatLng(parseFloat(e[d].image_latitude),parseFloat(e[d].image_longitude));this.bounds.extend(h);if(e[d].markerOnly==true){if(e[d].draggable){var f={draggable:true};var b=new GMarker(h,f);GEvent.addListener(b,"drag",function(i){$(this.coordId).update(this._point2Deg(i))}.bind(this));GEvent.addListener(b,"dragend",function(i){this.geocoder.getLocations(i,function(k){this.getLocationCallback(k,new GMarker(i))}.bind(this))}.bind(this))}else{var b=new GMarker(h,{zIndexProcess:function(i){return GOverlay.getZIndex(-90)}})}}else{var b=new anselGOverlay(h,e[d])}if(!e[d].markerOnly&&!options.viewType=="Block"){(function(){var i=e[d];GEvent.addDomListener(b.div_,"click",function(){a=$$("#"+this.tilePrefix+i.image_id+" a")[0];if(!a.onclick||a.onclick()!=false){location.href=a.href}}.bind(this))}.bind(this))()}b.image_data=e[d];this.points.push(b);if(this.options.smallMap&&(options.viewType!="Image"||e[d].markerOnly)){var g=new GMarker(h,this.tIO);this.smallMap.addOverlay(g)}}if(this.options.viewType=="Gallery"||this.options.viewType=="Block"){if(this.options.calculateMaxZoom){this.mainMap.getCurrentMapType().getMaxZoomAtLatLng(this.bounds.getCenter(),function(i){if(i.status!=200){var k=Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,this.maxZoom)}else{var k=Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,Math.min(this.maxZoom,i.zoom-1))}this._mapSetCenter(k);this._managerSetup(j)}.bind(this))}else{this._mapSetCenter(Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,this.maxZoom));this._managerSetup(j)}}else{this.mainMap.setCenter(this.points[0].getLatLng(),Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,this.maxZoom));if(this.options.useManager&&this.manager==null){this.manager=new MarkerManager(this.mainMap)}if(this.options.useManager){if(j==null){j=0}this.manager.addMarkers(this.points,j);this.manager.refresh()}if(this.options.smallMap){this.smallMap.setCenter(this.mainMap.getCenter(),1)}}},_mapSetCenter:function(b,c){this.mainMap.setCenter(this.bounds.getCenter(),b);if(this.options.smallMap){this.smallMap.setCenter(this.mainMap.getCenter(),1)}},_managerSetup:function(b){if(this.options.useManager&&this.manager==null){this.manager=new MarkerManager(this.mainMap)}if(this.options.useManager){if(b==null){b=0}this.manager.addMarkers(this.points,b);this.manager.refresh()}},display:function(){var b=this.points.length;for(var c=0;c<b;c++){(function(){var d=this.points[c];if(!this.options.useManager){this.mainMap.addOverlay(d)}if((this.options.viewType!="Block"&&this.options.viewType!="Image")||d.image_data.markerOnly){this.getLocations(d)}}.bind(this))()}if(this.options.clickHandler){GEvent.addListener(this.mainMap,"click",this.options.clickHandler)}},getLocations:function(b){if(b.image_data.image_location.length>0){r={Status:{code:200},Placemark:[{AddressDetails:{Accuracy:4},address:b.image_data.image_location}],NoUpdate:true};this.getLocationCallback(r,b,false)}else{this.geocoder.getLocations(b.getLatLng(),function(c){this.getLocationCallback(c,b,true)}.bind(this))}},getLocationCallback:function(e,c,g){if(typeof g=="undefined"){g=false}if(e.Status.code!=200){e.Placemark=[{AddressDetails:{Accuracy:0},address:""}];g=false}if(c.image_data){var f=c.image_data}else{f={}}for(var d=0;d<e.Placemark.length;d++){var b=e.Placemark[d];if(b.AddressDetails.Accuracy<=4){if(!f.markerOnly&&this.options.viewType=="Gallery"&&this.locationId){GEvent.addDomListener(c.div_,"mouseover",function(){$(this.locationId).update(b.address);$$("#"+this.tilePrefix+f.image_id+" img")[0].toggleClassName("image-tile-highlight")}.bind(this));GEvent.addDomListener(c.div_,"mouseout",function(){$(this.locationId).update("<br />");$$("#"+this.tilePrefix+f.image_id+" img")[0].toggleClassName("image-tile-highlight")}.bind(this))}if(g){new Ajax.Request(this.options.updateEndpoint,{method:"post",parameters:{requestType:"ImageSaveGeolocation/type=location/img="+f.image_id+"/location="+encodeURIComponent(b.address)}})}if(this.options.viewType=="Gallery"){if(this.locationId){$$("#"+this.tilePrefix+f.image_id+" img")[0].observe("mouseover",function(){$(this.locationId).update(b.address);$$("#"+this.tilePrefix+f.image_id+" img")[0].toggleClassName("image-tile-highlight");c.focus()}.bind(this));$$("#"+this.tilePrefix+f.image_id+" img")[0].observe("mouseout",function(){$(this.locationId).update("<br />");$$("#"+this.tilePrefix+f.image_id+" img")[0].toggleClassName("image-tile-highlight");c.div_.style.border="1px solid white";c.focus()}.bind(this))}return}else{if(this.options.viewType=="Image"){if(f.markerOnly){if(this.locationId){$(this.locationId).update(b.address)}if(this.coordId){$(this.coordId).update(this._point2Deg(c.getLatLng()))}if(this.relocateId){$(this.relocateId).update(this._getRelocateLink(f.image_id))}if(this.deleteId){$(this.deleteId).update(this._getDeleteLink(f.image_id))}}return}else{$(this.locationId).update(b.address);$(this.coordId).update(this._point2Deg(c.getLatLng()));return}}}else{}}},_point2Deg:function(c){function b(i,h){var g=h?(i>0?"N":"S"):(i>0?"E":"W");i=Math.abs(i);var f=Math.floor(i);var d=Math.floor((i-f)*60);var e=(i-f-d/60)*3600;return f+"&deg; "+d+"' "+e.toFixed(2)+'" '+g}return b(c.lat(),true)+" "+b(c.lng())},_getRelocateLink:function(c){if(options.hasEdit){var b=new Element("a",{href:this.options.relocateUrl+"?image="+c}).update(this.options.relocateText);b.observe("click",function(d){popup(this.options.relocateUrl+"?image="+c,750,600);d.stop()}.bind(this));return b}else{return""}},_getDeleteLink:function(c){var b=new Element("a",{href:this.options.relocateUrl+"?image="+c}).update(this.options.deleteGeotagText);b.observe("click",function(d){this.options.deleteGeotagCallback();d.stop()}.bindAsEventListener(this));return b}};anselGOverlay=function(e,c){this.src_=c.icon;this.latlng_=e;var b=new Image();b.src=c.icon;this.width_=b.width;this.height_=b.height;var d=GOverlay.getZIndex(this.latlng_.lat());this.div_=new Element("div",{style:"position:absolute;border:1px solid white;width:"+(this.width_-2)+"px; height:"+(this.height_-2)+"px;zIndex:"+d});this.img_=new Element("img",{src:this.src_,style:"width:"+(this.width_-2)+"px;height:"+(this.height_-2)+"px"});this.div_.appendChild(this.img_);this.selected_=false;this.link=c.link;GEvent.addDomListener(this.div_,"mouseover",function(){this.focus()}.bind(this));GEvent.addDomListener(this.div_,"mouseout",function(){this.focus()}.bind(this));if(this.link){GEvent.addDomListener(this.div_,"click",function(){var f=this.link;location.href=f}.bind(this))}};anselGOverlay.prototype=new GOverlay();anselGOverlay.prototype.initialize=function(b){b.getPane(G_MAP_MARKER_PANE).appendChild(this.div_);this.map_=b};anselGOverlay.prototype.remove=function(){this.div_.parentNode.removeChild(this.div_)};anselGOverlay.prototype.copy=function(){return new Ansel_GOverlay(this.latlng_,this.src_)};anselGOverlay.prototype.redraw=function(c){if(!c){return}var b=this.map_.fromLatLngToDivPixel(this.latlng_);this.div_.style.left=b.x+"px";this.div_.style.top=b.y+"px"};anselGOverlay.prototype.focus=function(){if(this.selected_==false){this.div_.style.border="1px solid red";this.div_.style.left=(parseInt(this.div_.style.left)-1)+"px";this.div_.style.top=(parseInt(this.div_.style.top)-1)+"px";this.div_.style.zIndex=GOverlay.getZIndex(-90);this.selected_=true}else{this.div_.style.border="1px solid white";this.div_.style.left=(parseInt(this.div_.style.left)+1)+"px";this.div_.style.top=(parseInt(this.div_.style.top)+1)+"px";this.div_.style.zIndex=GOverlay.getZIndex(this.latlng_.lat());this.selected_=false}};anselGOverlay.prototype.getPoint=function(){return this.latlng_};anselGOverlay.prototype.getLatLng=function(){return this.latlng_};