var Ansel_GMap=Class.create();Ansel_GMap.prototype={mainMap:undefined,smallMap:undefined,tI:undefined,tIO:undefined,bounds:undefined,geocoder:undefined,manager:undefined,tilePrefix:"imagetile_",locationId:"ansel_locationtext",coordId:"ansel_latlng",relocateId:"ansel_relocate",deleteId:"ansel_deleteGeotag",maxZoom:15,defaultZoom:15,options:{},points:[],initialize:function(A){if(typeof A.useManager=="undefined"){A.useManager=true}this.mainMap=new GMap2($(A.mainMap));this.mainMap.setMapType(G_HYBRID_MAP);this.mainMap.setUIToDefault();this.bounds=new GLatLngBounds();this.geocoder=new GClientGeocoder();this.options=A;if(A.tilePrefix){this.tilePrefix=A.tilePrefix}if(typeof A.calculateMaxZoom=="undefined"){A.calculateMaxZoom=true}if(A.smallMap){this.smallMap=new GMap2($(A.smallMap));var B=this.smallMap.getDefaultUI();B.controls.menumaptypecontrol=false;this.smallMap.setUI(B);this.tI=new GIcon();this.tI.image="http://labs.google.com/ridefinder/images/mm_20_red.png";this.tI.shadow="http://labs.google.com/ridefinder/images/mm_20_shadow.png";this.tI.iconSize=new GSize(12,20);this.tI.shadowSize=new GSize(22,20);this.tI.iconAnchor=new GPoint(6,20);this.tI.infoWindowAnchor=new GPoint(5,1);this.tIO={icon:this.tI}}document.observe("unload",function(){GUnload()})},addPoints:function(D,H){var B=D.length;for(var C=0;C<B;C++){var G=new GLatLng(parseFloat(D[C].image_latitude),parseFloat(D[C].image_longitude));this.bounds.extend(G);if(D[C].markerOnly==true){if(D[C].draggable){var E={draggable:true};var A=new GMarker(G,E);GEvent.addListener(A,"drag",function(I){$(this.coordId).update(this._point2Deg(I))}.bind(this));GEvent.addListener(A,"dragend",function(I){this.geocoder.getLocations(I,function(J){this.getLocationCallback(J,new GMarker(I))}.bind(this))}.bind(this))}else{var A=new GMarker(G,{zIndexProcess:function(I){return GOverlay.getZIndex(-90)}})}}else{var A=new anselGOverlay(G,D[C])}if(!D[C].markerOnly&&!options.viewType=="Block"){(function(){var I=D[C];GEvent.addDomListener(A.div_,"click",function(){a=$$("#"+this.tilePrefix+I.image_id+" a")[0];if(!a.onclick||a.onclick()!=false){location.href=a.href}}.bind(this))}.bind(this))()}A.image_data=D[C];this.points.push(A);if(this.options.smallMap&&(options.viewType!="Image"||D[C].markerOnly)){var F=new GMarker(G,this.tIO);this.smallMap.addOverlay(F)}}if(this.options.viewType=="Gallery"||this.options.viewType=="Block"){if(this.options.calculateMaxZoom){this.mainMap.getCurrentMapType().getMaxZoomAtLatLng(this.bounds.getCenter(),function(I){if(I.status!=200){var J=Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,this.maxZoom)}else{var J=Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,Math.min(this.maxZoom,I.zoom-1))}this._mapSetCenter(J);this._managerSetup(H)}.bind(this))}else{this._mapSetCenter(Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,this.maxZoom));this._managerSetup(H)}}else{this.mainMap.setCenter(this.points[0].getLatLng(),Math.min(this.mainMap.getBoundsZoomLevel(this.bounds)-1,this.maxZoom));if(this.options.useManager&&this.manager==null){this.manager=new MarkerManager(this.mainMap)}if(this.options.useManager){if(H==null){H=0}this.manager.addMarkers(this.points,H);this.manager.refresh()}if(this.options.smallMap){this.smallMap.setCenter(this.mainMap.getCenter(),1)}}},_mapSetCenter:function(A,B){this.mainMap.setCenter(this.bounds.getCenter(),A);if(this.options.smallMap){this.smallMap.setCenter(this.mainMap.getCenter(),1)}},_managerSetup:function(A){if(this.options.useManager&&this.manager==null){this.manager=new MarkerManager(this.mainMap)}if(this.options.useManager){if(A==null){A=0}this.manager.addMarkers(this.points,A);this.manager.refresh()}},display:function(){var A=this.points.length;for(var B=0;B<A;B++){(function(){var C=this.points[B];if(!this.options.useManager){this.mainMap.addOverlay(C)}if((this.options.viewType!="Block"&&this.options.viewType!="Image")||C.image_data.markerOnly){this.getLocations(C)}}.bind(this))()}if(this.options.clickHandler){GEvent.addListener(this.mainMap,"click",this.options.clickHandler)}},getLocations:function(A){if(A.image_data.image_location.length>0){r={Status:{code:200},Placemark:[{AddressDetails:{Accuracy:4},address:A.image_data.image_location}],NoUpdate:true};this.getLocationCallback(r,A,false)}else{this.geocoder.getLocations(A.getLatLng(),function(B){this.getLocationCallback(B,A,true)}.bind(this))}},getLocationCallback:function(D,B,F){if(typeof F=="undefined"){F=false}if(D.Status.code!=200){D.Placemark=[{AddressDetails:{Accuracy:0},address:""}];F=false}if(B.image_data){var E=B.image_data}else{E={}}for(var C=0;C<D.Placemark.length;C++){var A=D.Placemark[C];if(A.AddressDetails.Accuracy<=4){if(!E.markerOnly&&this.options.viewType=="Gallery"&&this.locationId){GEvent.addDomListener(B.div_,"mouseover",function(){$(this.locationId).update(A.address);$$("#"+this.tilePrefix+E.image_id+" img")[0].toggleClassName("image-tile-highlight")}.bind(this));GEvent.addDomListener(B.div_,"mouseout",function(){$(this.locationId).update("<br />");$$("#"+this.tilePrefix+E.image_id+" img")[0].toggleClassName("image-tile-highlight")}.bind(this))}if(F){new Ajax.Request(this.options.updateEndpoint,{method:"post",parameters:{requestType:"ImageSaveGeolocation/type=location/img="+E.image_id+"/location="+encodeURIComponent(A.address)}})}if(this.options.viewType=="Gallery"){if(this.locationId){$$("#"+this.tilePrefix+E.image_id+" img")[0].observe("mouseover",function(){$(this.locationId).update(A.address);$$("#"+this.tilePrefix+E.image_id+" img")[0].toggleClassName("image-tile-highlight");B.focus()}.bind(this));$$("#"+this.tilePrefix+E.image_id+" img")[0].observe("mouseout",function(){$(this.locationId).update("<br />");$$("#"+this.tilePrefix+E.image_id+" img")[0].toggleClassName("image-tile-highlight");B.div_.style.border="1px solid white";B.focus()}.bind(this))}return}else{if(this.options.viewType=="Image"){if(E.markerOnly){if(this.locationId){$(this.locationId).update(A.address)}if(this.coordId){$(this.coordId).update(this._point2Deg(B.getLatLng()))}if(this.relocateId){$(this.relocateId).update(this._getRelocateLink(E.image_id))}if(this.deleteId){$(this.deleteId).update(this._getDeleteLink(E.image_id))}}return}else{$(this.locationId).update(A.address);$(this.coordId).update(this._point2Deg(B.getLatLng()));return}}}else{}}},_point2Deg:function(B){function A(H,G){var F=G?(H>0?"N":"S"):(H>0?"E":"W");H=Math.abs(H);var E=Math.floor(H);var C=Math.floor((H-E)*60);var D=(H-E-C/60)*3600;return E+"&deg; "+C+"' "+D.toFixed(2)+'" '+F}return A(B.lat(),true)+" "+A(B.lng())},_getRelocateLink:function(B){if(options.hasEdit){var A=new Element("a",{href:this.options.relocateUrl+"?image="+B}).update(this.options.relocateText);A.observe("click",function(C){popup(this.options.relocateUrl+"?image="+B,750,600);C.stop()}.bind(this));return A}else{return""}},_getDeleteLink:function(B){var A=new Element("a",{href:this.options.relocateUrl+"?image="+B}).update(this.options.deleteGeotagText);A.observe("click",function(C){this.options.deleteGeotagCallback();C.stop()}.bindAsEventListener(this));return A}};anselGOverlay=function(D,B){this.src_=B.icon;this.latlng_=D;var A=new Image();A.src=B.icon;this.width_=A.width;this.height_=A.height;var C=GOverlay.getZIndex(this.latlng_.lat());this.div_=new Element("div",{style:"position:absolute;border:1px solid white;width:"+(this.width_-2)+"px; height:"+(this.height_-2)+"px;zIndex:"+C});this.img_=new Element("img",{src:this.src_,style:"width:"+(this.width_-2)+"px;height:"+(this.height_-2)+"px"});this.div_.appendChild(this.img_);this.selected_=false;this.link=B.link;GEvent.addDomListener(this.div_,"mouseover",function(){this.focus()}.bind(this));GEvent.addDomListener(this.div_,"mouseout",function(){this.focus()}.bind(this));if(this.link){GEvent.addDomListener(this.div_,"click",function(){var E=this.link;location.href=E}.bind(this))}};anselGOverlay.prototype=new GOverlay();anselGOverlay.prototype.initialize=function(A){A.getPane(G_MAP_MARKER_PANE).appendChild(this.div_);this.map_=A};anselGOverlay.prototype.remove=function(){this.div_.parentNode.removeChild(this.div_)};anselGOverlay.prototype.copy=function(){return new Ansel_GOverlay(this.latlng_,this.src_)};anselGOverlay.prototype.redraw=function(B){if(!B){return}var A=this.map_.fromLatLngToDivPixel(this.latlng_);this.div_.style.left=A.x+"px";this.div_.style.top=A.y+"px"};anselGOverlay.prototype.focus=function(){if(this.selected_==false){this.div_.style.border="1px solid red";this.div_.style.left=(parseInt(this.div_.style.left)-1)+"px";this.div_.style.top=(parseInt(this.div_.style.top)-1)+"px";this.div_.style.zIndex=GOverlay.getZIndex(-90);this.selected_=true}else{this.div_.style.border="1px solid white";this.div_.style.left=(parseInt(this.div_.style.left)+1)+"px";this.div_.style.top=(parseInt(this.div_.style.top)+1)+"px";this.div_.style.zIndex=GOverlay.getZIndex(this.latlng_.lat());this.selected_=false}};anselGOverlay.prototype.getPoint=function(){return this.latlng_};anselGOverlay.prototype.getLatLng=function(){return this.latlng_};