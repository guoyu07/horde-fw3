var SpellChecker=Class.create({options:{},resumeOnDblClick:true,state:"CheckSpelling",initialize:function(A,E,C,I,B,G){var F,H,D;this.url=A;this.target=E;this.statusButton=$(C);this.buttonStates=I;this.statusClass=G||"";this.statusButton.observe("click",this.process.bindAsEventListener(this));this.options.onComplete=this.onComplete.bind(this);if(B){F=new Element("DIV",{className:"autocomplete",id:"spellcheckpopdown"}).setStyle({position:"absolute"}).hide();D=new Element("UL");$H(B).each(function(J){D.insert({bottom:new Element("LI",{lc:J.key}).update(J.value)})});F.insert({bottom:D});this.localeChoices=new KeyNavList(F,{onChoose:this.setLocale.bindAsEventListener(this)});H=new Element("A",{className:"popdown"}).insert("&nbsp;").observe("click",function(){$("spellcheckpopdown").clonePosition(this.statusButton,{setHeight:false,setWidth:false,offsetTop:this.statusButton.getHeight()});this.localeChoices.show()}.bind(this));this.statusButton.insert({after:H});$(document.body).insert(F)}document.observe("click",this.onClick.bindAsEventListener(this));this.status("CheckSpelling")},setLocale:function(A){this.locale=A.readAttribute("lc")},targetValue:function(){var A=$(this.target);return(Object.isUndefined(A.value))?A.innerHTML:A.value},process:function(A){switch(this.state){case"CheckSpelling":this.spellCheck();break;case"ResumeEdit":this.resume();break}A.stop()},spellCheck:function(){if(this.onBeforeSpellCheck){this.onBeforeSpellCheck()}var B=Object.clone(this.options),C=$H(),A=this.url;this.status("Checking");this.removeChoices();C.set(this.target,this.targetValue());B.parameters=C.toQueryString();if(this.locale){A+="/locale="+this.locale}if(this.htmlAreaParent){A+="/html=1"}new Ajax.Request(A,B)},onClick:function(B){if(this.localeChoices){this.localeChoices.hide()}if(!this.choicesDiv){return true}var A=B.findElement("SPAN");if(A&&A==this.curWord){return true}this.removeChoices();this.curWord=null},onComplete:function(B){var A,E,F,H,D,C=0,G=$(this.target),I=B.responseText.evalJSON(true);this.removeChoices();if(Object.isUndefined(I)){this.resume();this.status("Error");return}A=I.bad||[];this.suggestions=I.suggestions||[];E=this.targetValue();if(this.htmlAreaParent){E=E.replace(/\r?\n/g,"")}else{E=E.replace(/\r?\n/g,"~~~").escapeHTML()}$A(A).each(function(J){H=new RegExp("(?:^|\\b)"+RegExp.escape(J)+"(?:\\b|$)","g");D='<span index="'+(C++)+'" name="incorrect" class="incorrect">'+J+"</span>";E=E.replace(H,D);if(this.htmlAreaParent){E=E.replace(new RegExp("(<[^>]*)"+RegExp.escape(D)+"([^>]*>)","g"),"$1"+J+"$2")}},this);if(!this.reviewDiv){this.reviewDiv=new Element("div",{className:G.readAttribute("className")+" spellcheck"}).setStyle({overflow:"auto"});if(this.resumeOnDblClick){this.reviewDiv.observe("dblclick",this.resume.bind(this))}}F=G.getDimensions();this.reviewDiv.setStyle({width:F.width+"px",height:F.height+"px"});if(!this.htmlAreaParent){E=E.replace(/~~~/g,"<br />")}this.reviewDiv.update(E);this.reviewDiv.select('span[name="incorrect"]').invoke("observe","click",this.showSuggestions.bindAsEventListener(this));this.reviewDiv.select("A").invoke("observe","click",Event.stop);if(this.htmlAreaParent){Element.hide(this.htmlArea);$(this.htmlAreaParent).insert({bottom:this.reviewDiv})}else{G.hide().insert({before:this.reviewDiv})}this.status("ResumeEdit")},showSuggestions:function(D){var E,A=D.element(),B=new Element("UL");try{E=A.viewportOffset()}catch(C){E=[D.pointerX(),D.pointerY()]}this.removeChoices();this.choicesDiv=new Element("DIV",{className:"autocomplete"}).setStyle({left:E[0]+"px",top:(E[1]+16)+"px"}).hide();this.curWord=A;$A(this.suggestions[this.curWord.readAttribute("index")]).each(function(F){B.insert({bottom:new Element("LI").update(F)})});this.choicesDiv.insert({bottom:B});this.choices=new KeyNavList(this.choicesDiv,{onChoose:function(F){this.replaceWord(F,this.curWord)}.bind(this)}).show();$(document.body).insert(this.choicesDiv)},replaceWord:function(A,B){B.update(A.innerHTML).writeAttribute({className:"corrected"});this.removeChoices()},removeChoices:function(){if(this.choicesDiv){this.choicesDiv.remove();this.choicesDiv=null}},resume:function(){this.removeChoices();if(!this.reviewDiv){return}var A=$(this.target),B;this.reviewDiv.select('span[name="incorrect"]').each(function(C){C.replace(C.innerHTML)});this.reviewDiv.select("A").invoke("stopObserving","click");B=this.reviewDiv.innerHTML;if(!this.htmlAreaParent){B=B.replace(/<br *\/?>/gi,"~~~").unescapeHTML().replace(/~~~/g,"\n")}A.value=B;A.disabled=false;if(this.resumeOnDblClick){this.reviewDiv.stopObserving("dblclick")}this.reviewDiv.remove();this.reviewDiv=null;this.status("CheckSpelling");if(this.htmlAreaParent){Element.show(this.htmlArea)}else{A.show()}if(this.onAfterSpellCheck){this.onAfterSpellCheck()}},status:function(A){if(!this.statusButton){return}this.state=A;switch(this.statusButton.tagName){case"INPUT":this.statusButton.value=this.buttonStates[A];break;case"A":this.statusButton.update(this.buttonStates[A]);break}this.statusButton.className=this.statusClass+" "+A},isActive:function(){return(this.reviewDiv)}});