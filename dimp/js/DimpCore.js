var frames={horde_main:true},DimpCore={view_id:1,remove_gc:[],server_error:0,buttons:["button_reply","button_forward","button_spam","button_ham","button_deleted"],debug:function(A,B){if(!this.is_logout&&DIMP.conf.debug){alert(A+": "+(B instanceof Error?B.name+"-"+B.message:Object.inspect(B)))}},toUIDArray:function(A){return A.get("dataob").collect(function(B){return this.toUIDString(B.imapuid,B.view)},this)},toUIDString:function(B,A){return B+DIMP.conf.idx_sep+A},doAction:function(C,D,B,E,A){if(!this.doActionOpts){this.doActionOpts={onException:function(F,G){this.debug("onException",G)}.bind(this),onFailure:function(F,G){this.debug("onFailure",F)}.bind(this)}}A=Object.extend(this.doActionOpts,A||{});D=$H(D);C=C.startsWith("*")?C.substring(1):DIMP.conf.URI_IMP+"/"+C;if(B&&B.size()){D.set("uid",B.toJSON())}if(DIMP.conf.SESSION_ID){D.update(DIMP.conf.SESSION_ID.toQueryParams())}A.parameters=D.toQueryString();A.onComplete=function(F,G){this.doActionComplete(F,E)}.bind(this);new Ajax.Request(C,A)},doActionComplete:function(C,E){this.inAjaxCallback=true;var A=false,B={};if(!C.responseText||!C.responseText.length){A=true}else{try{B=C.responseText.evalJSON(true)}catch(D){this.debug("doActionComplete",D);A=true}}if(!B.msgs){B.msgs=[]}if(A){if(++this.server_error==3){this.showNotifications([{type:"horde.error",message:DIMP.text.ajax_timeout}])}this.inAjaxCallback=false;return}if(B.response&&Object.isFunction(E)){try{E(B)}catch(D){this.debug("doActionComplete callback",D)}}if(this.server_error>=3){B.msgs.push({type:"horde.success",message:DIMP.text.ajax_recover})}this.server_error=0;if(!B.msgs_noauto){this.showNotifications(B.msgs)}if(this.onDoActionComplete){this.onDoActionComplete(B)}this.inAjaxCallback=false},setTitle:function(A){document.title=DIMP.conf.name+" :: "+A},showNotifications:function(A){if(!A.size()||this.is_logout){return}var B=$("alerts");if(!B){B=new Element("DIV",{id:"alerts"});$(document.body).insert(B)}A.find(function(C){switch(C.type){case"dimp.timeout":this.is_logout=true;this.redirect(DIMP.conf.timeout_url);return true;case"horde.error":case"horde.message":case"horde.success":case"horde.warning":case"imp.reply":case"imp.forward":case"imp.redirect":case"dimp.request":case"dimp.sticky":var G,E,F,D,H=new Element("DIV",{className:C.type.replace(".","-")});if($w("dimp.request dimp.sticky").indexOf(C.type)!=-1){H.update(C.message)}else{H.insert(C.message.unescapeHTML().unescapeHTML())}B.insert(H);if(DIMP.conf.is_ie6){F=new Element("DIV",{className:"ie6alertsfix"}).clonePosition(H,{setLeft:false,setTop:false});G=F;F.insert(H.remove());B.insert(F)}else{G=H}E=Effect.Fade.bind(this,H,{duration:1.5,afterFinish:this.removeAlert.bind(this)});G.observe("click",E);if($w("horde.error dimp.request dimp.sticky").indexOf(C.type)==-1){E.delay(C.type=="horde.warning"?10:5)}if(C.type=="dimp.request"){D=function(){E();document.stopObserving("click",D)};document.observe("click",D)}}},this)},removeAlert:function(C){try{var A=$(C.element),B=A.up();if(B&&B.parentNode){this.addGC(A.remove());if(!B.childElements().size()&&B.hasClassName("ie6alertsfix")){this.addGC(B.remove())}}}catch(D){this.debug("removeAlert",D)}},compose:function(C,B){var A=DIMP.conf.compose_url;B=B||{};if(C){B.type=C}this.popupWindow(this.addURLParam(A,B),"compose"+new Date().getTime())},popupWindow:function(B,A){if(!(window.open(B,A.replace(/\W/g,"_"),"width="+DIMP.conf.popup_width+",height="+DIMP.conf.popup_height+",status=1,scrollbars=yes,resizable=yes"))){this.showNotifications([{type:"horde.warning",message:DIMP.text.popup_block}])}},closePopup:function(){if(this.inAjaxCallback){this.closePopup.bind(this).defer()}else{window.close()}},logout:function(){this.is_logout=true;this.redirect(DIMP.conf.URI_IMP+"/LogOut")},redirect:function(A){A=this.addSID(A);if(parent.frames.horde_main){parent.location=A}else{window.location=A}},addMouseEvents:function(A){this.DMenu.addElement(A.id,"ctx_"+A.type,A)},removeMouseEvents:function(A){this.DMenu.removeElement($(A).readAttribute("id"));this.addGC(A)},addPopdown:function(B,A){var D=$(B),C=D.up();C.insert($($("popdown_img").cloneNode(false)).writeAttribute("id",B+"_img").show());this.addMouseEvents({id:B+"_img",type:A,offset:C,left:true})},buildAddressLinks:function(B){var A=0;$(B).select(".address").each(function(C){C.writeAttribute({id:"addr"+A++});C.observe("mouseover",function(){this.addMouseEvents({id:C.id,type:"contacts",offset:C,left:true})}.bind(this))},this);$("msgHeadersContent").select(".largeaddrlist").each(function(C){this.clickObserveHandler({d:C,f:function(){C.up().down().toggle().next().toggle().next().toggle()}})},this)},removeAddressLinks:function(A){[$(A).select(".address"),$(A).select(".largeaddrlist")].flatten().compact().each(this.removeMouseEvents.bind(this))},messageOnLoad:function(){var A=this.clickObserveHandler;if($("partlist")){A({d:$("partlist_col").up(),f:function(){$("partlist","partlist_col","partlist_exp").invoke("toggle")}})}if($("msg_print")){A({d:$("msg_print"),f:function(){window.print()}})}if($("msg_view_source")){A({d:$("msg_view_source"),f:function(){view(DIMP.conf.msg_source_link.unescapeHTML(),DIMP.conf.msg_index+"|"+DIMP.conf.msg_folder)}.bind(this)})}A({d:$("ctx_contacts_new"),f:function(){this.compose("new",{to:this.DMenu.element().readAttribute("address")})}.bind(this),ns:true});A({d:$("ctx_contacts_add"),f:function(){this.doAction("AddContact",{name:this.DMenu.element().readAttribute("personal"),email:this.DMenu.element().readAttribute("email")},null,true)}.bind(this),ns:true})},addGC:function(A){this.remove_gc=this.remove_gc.concat(A)},clickObserveHandler:function(A){return A.d.observe("click",DimpCore._clickFunc.curry(A))},_clickFunc:function(B,A){B.p?B.f(A):B.f();if(!B.ns){A.stop()}},addSID:function(A){if(!DIMP.conf.SESSION_ID){return A}return this.addURLParam(A,DIMP.conf.SESSION_ID.toQueryParams())},addURLParam:function(A,C){var B=A.indexOf("?");if(B!=-1){C=$H(A.toQueryParams()).merge(C).toObject();A=A.substring(0,B)}return A+"?"+Object.toQueryString(C)}};if(typeof ContextSensitive!="undefined"){DimpCore.DMenu=new ContextSensitive()}document.observe("dom:loaded",function(){try{if(parent.opener&&parent.opener.location.host==window.location.host&&parent.opener.DimpCore){DIMP.baseWindow=parent.opener.DIMP.baseWindow||parent.opener}}catch(A){}if(!DIMP.conf.spam_reporting){DimpCore.buttons=DimpCore.buttons.without("button_spam")}if(!DIMP.conf.ham_reporting){DimpCore.buttons=DimpCore.buttons.without("button_ham")}new PeriodicalExecuter(function(){if(DimpCore.remove_gc.size()){try{$A(DimpCore.remove_gc.splice(0,75)).compact().invoke("stopObserving")}catch(B){DimpCore.debug("remove_gc[].stopObserving",B)}}},10)});Element.addMethods({setText:function(B,C){var A=0;$A(B.childNodes).each(function(D){if(D.nodeType==3){if(A++){Element.remove(D)}else{D.nodeValue=C}}});if(!A){$(B).insert(C)}},getText:function(B,A){var C="";$A(B.childNodes).each(function(D){if(D.nodeType==3){C+=D.nodeValue}else{if(A&&D.hasChildNodes()){C+=$(D).getText(true)}}});return C}});Object.extend(String.prototype,{evalScripts:function(){var func,i=0,length,scripts=this.extractScripts(),re=/function\s+([^\s(]+)/g;for(length=scripts.size();i<length;++i){eval(scripts[i]);while(func=re.exec(scripts[i])){window[func[1]]=eval(func[1])}}}});function popup_imp(C,A,D,B){DimpCore.compose("new",B.toQueryParams().toObject())}function toggleQuoteBlock(E,B){var D=$("qb_"+E).toggle(),A=$("qt_"+E),C=A.down();C=A.down();if(C){C.remove()}A.insert(new Element("A",{className:"widget togglequote"}).setStyle({fontSize:"70%"}).insert("["+(D.visible()?DIMP.text.hidetext:DIMP.text.showtext+" - "+B+" "+DIMP.text.lines)+"]").observe("click",toggleQuoteBlock.curry(E,B)))}function view(A,B){window.open(A,++DimpCore.view_id+B.replace(/\W/g,"_"),"menubar=yes,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes")}if(Prototype.Browser.Opera&&opera.version()>=9.5){document.viewport.getDimensions=function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}}};